<!doctype html>
<html lang="en">

<head>
    <title>Bank Api Demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
        crossorigin="anonymous"></link>

    <script src="/js/bank-api.min.js"
        integrity="sha384-HASH_VALUE"
        crossorigin="anonymous"></script> 

    <style>
        #login-info {
            background: #53a8f891;
            text-align: right;
            padding-top: 0px;
            padding-bottom: 0px;
        }

        .panel-log {
            background: #dddddddd;
            text-align: left;
            padding-top: 0px;
            padding-bottom: 0px;
        }

        .panel-err {
            background: #f582827a;
            text-align: left;
            padding-top: 0px;
            padding-bottom: 0px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1>Bank Api Demo</h1>

        <div class="row mt-3" id="login-info">
            <div class="col-12 text-right">
                <button type="button" class="btn btn-primary" id="btnLogin" style="display: none" data-toggle="modal"
                    data-target="#loginModal">Login</button>
                <button type="button" class="btn btn-primary" id="btnLogout" style="display: none"
                    onclick="closeSession()">Logout</button>
            </div>
                
            <!-- Modal -->
            <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="loginModalLabel">Login</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="input-group mb-3" id="credentials">
                                <div class="session">
                                    <input type="text" class="form-control" id="login" placeholder="login">
                                </div>
                                <div class="session">
                                    <input type="password" class="form-control" id="password" placeholder="password">
                                </div>
                                <button type="buton" class="btn btn-primary default"
                                    onclick="openSession($('#login').val(), $('#password').val())">Login</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12 text-center">
                <button class="synaps-verify-btn-blue" id="synaps-kyc" style="display: none">Start KYC</button>
            </div>
        </div>
        <div class="row mt-3">
            <div col-12 class="col-12 text-left" id="log-info">
                <button class="btn btn-primary" onclick="clearLog()">Clear log</button>
                <div class="panel-err" id="err"></div>
                <div class="panel-log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        function toggleButton(button, enable) {
            button.prop('disabled', !enable);
            if (enable) {
                button.show()
            } else {
                button.hide()
            }
        }

        function showKycButton(enable) {
            toggleButton($('#synaps-kyc'), enable)
            if (!enable) {
                return
            }

            bank_api.setupSynaps((type, kycId) => {
                if (type === 'userOnboardSuccess') {
                    log($('#log'), "User onboard success: " + kycId);

                } else if (type === 'userOnboardDeclined') {
                    log($('#err'), "User onboard declined");

                } else if (type === 'userExited') {
                    log($('#err'), "User exited. kycId: " + kycId);
                }
            })
        };

        function openSession(login, password) {
            bank_api.openSession({login, password}, (err, result) => {
                stopRenewer();

                const sessionRenewerId = setInterval(bank_api.renewSession, 30000, onSessionRenew);
                sessionStorage.setItem("bankApi:sessionRenewerId", sessionRenewerId);
                onSessionOpen(err, result);
            })
        };

        function closeSession() {
            stopRenewer();
            updateLogin(false);

            bank_api.closeSession(onSessionClose);
        };

        function updateLogin(loggedIn) {
            toggleButton($('#btnLogin'), !loggedIn);
            toggleButton($('#btnLogout'), loggedIn);
            showKycButton(loggedIn);
        }

        function onSessionOpen(err, result) {
            $('#loginModal').modal('hide');
            $('#password').val('');

            const loggedIn = !err && result.sessionId;
            updateLogin(loggedIn);

            if (err) {
                if (err.error) {
                    err = err.error;
                }
                log($('#err'), "Error: " + JSON.stringify(err, null, 0));
                return;
            }
            log($('#log'), "Session Opened: " + result.sessionId)
        };


        function onSessionRenew(err, result) {
            if (err) {
                if (err.error) {
                    err = err.error;
                }
                log($('#err'), "Error: " + JSON.stringify(err, null, 0));
                return;
            }

            log($('#log'), "Session Renewed: " + result.sessionId);
        }

        function onSessionClose(err, result) {
            if (err) {
                if (err.error) {
                    err = err.error;
                }
                log($('#err'), "Error: " + JSON.stringify(err, null, 0));
                return
            }
            log($('#log'), "Session Closed: " + result.sessionId);
        };
    </script>


    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <script>
        $(document).ready(function(){
            toggleButton($('#btnLogin'), true);
            toggleButton($('#btnLogout'), false);
            showKycButton(false);
        });

        function stopRenewer() {
            sessionRenewerId = sessionStorage.getItem("bankApi:sessionRenewerId")
            if (sessionRenewerId) {
                clearInterval(sessionRenewerId);
                sessionStorage.removeItem("bankApi:sessionRenewerId");
            }
        }

        function log(out, msg) {
            d = new Date();
            str = d.toLocaleDateString() + " - " + d.toLocaleTimeString();
            out.prepend("<br/>" + str + " : " + msg);
        }

        function clearLog() {
            $('#log').empty();
            $('#err').empty();
        };

    </script>

</body>
</html>